# Location Autocomplete System

This document describes the robust location autocomplete system implemented for the Vakay trip planner application.

## Overview

The system provides intelligent autocomplete for popular tourist destinations, cities, islands, and attractions while excluding unwanted items like museums, monuments, and buildings. It's designed to work with external data pipelines that fetch location data from Nominatim.

## Architecture

### Database Schema

The system uses a `popular_destinations` table with the following structure:

```sql
CREATE TABLE popular_destinations (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  place_id bigint NOT NULL UNIQUE, -- Nominatim place_id
  name text NOT NULL,
  display_name text NOT NULL,
  category text NOT NULL, -- tourism, place, etc.
  type text NOT NULL, -- attraction, city, island, etc.
  country text,
  region text,
  city text,
  lat decimal(10, 8) NOT NULL,
  lon decimal(11, 8) NOT NULL,
  importance decimal(10, 9) NOT NULL,
  place_rank integer NOT NULL,
  boundingbox text[], -- [min_lat, max_lat, min_lon, max_lon]
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

### Key Features

- **Full-text search** using PostgreSQL's GIN indexes
- **Category and type filtering** to ensure only relevant destinations
- **Importance-based ranking** for better search results
- **Geographic data** including coordinates and bounding boxes
- **Row Level Security** enabled for data protection

## Setup Instructions

### 1. Database Setup

Run the SQL script to create the table and indexes:

```bash
psql -d your_database -f setup-popular-destinations.sql
```

### 2. Sample Data

The setup script includes sample data for testing. Replace this with your actual pipeline data.

### 3. API Endpoints

The system provides two main endpoints:

#### GET `/api/locations/search`
Search for destinations with autocomplete functionality.

**Query Parameters:**
- `q` (required): Search query (minimum 2 characters)
- `limit` (optional): Maximum results (default: 10)
- `category` (optional): Filter by category (tourism, place)
- `type` (optional): Filter by type (attraction, city, island)

**Example:**
```bash
GET /api/locations/search?q=paris&limit=5
```

#### POST `/api/locations/search`
Bulk insert destinations from your external pipeline.

**Request Body:**
```json
{
  "destinations": [
    {
      "place_id": 238016130,
      "name": "Angkor Wat",
      "display_name": "Angkor Wat, Siem Reap, Cambodia",
      "category": "tourism",
      "type": "attraction",
      "country": "Cambodia",
      "region": "Siem Reap",
      "city": "Siem Reap",
      "lat": "13.4124426",
      "lon": "103.8665873",
      "importance": "0.557888037798644",
      "place_rank": "30",
      "boundingbox": ["13.4083770", "13.4165641", "103.8614147", "103.8717328"]
    }
  ]
}
```

## External Data Pipeline Integration

### Data Requirements

Your external pipeline should provide data in the Nominatim format. The system will:

1. **Validate** the data structure
2. **Filter** out unwanted items (museums, monuments, etc.)
3. **Transform** coordinates and numeric values
4. **Upsert** into the database (updates existing records)

### Recommended Data Sources

- **Major cities** (population > 100,000)
- **Tourist attractions** (importance > 0.3)
- **Islands and regions** (geographic significance)
- **National parks** and natural landmarks
- **UNESCO World Heritage sites**

### Data Quality Guidelines

- Ensure `place_id` is unique across all sources
- Use consistent category and type values
- Provide accurate coordinates
- Include full address information when available

## Frontend Components

### Autocomplete Component

The `Autocomplete` component provides:

- **Debounced search** (300ms default)
- **Keyboard navigation** (arrow keys, enter, escape)
- **Category icons** for visual distinction
- **Loading states** and error handling
- **Responsive design** for mobile and desktop

### Usage Example

```tsx
import { Autocomplete, AutocompleteOption } from '@/components/ui/autocomplete';

function LocationSearch() {
  const [value, setValue] = useState('');
  
  const handleSelect = (destination: AutocompleteOption) => {
    console.log('Selected:', destination.name);
    // Handle selection
  };

  return (
    <Autocomplete
      value={value}
      onChange={setValue}
      onSelect={handleSelect}
      placeholder="Search destinations..."
      minQueryLength={2}
      debounceMs={300}
      maxResults={10}
    />
  );
}
```

## Performance Considerations

### Database Optimization

- **GIN indexes** on text fields for fast full-text search
- **Composite indexes** for common query patterns
- **Importance-based ordering** for relevant results

### Frontend Optimization

- **Debounced search** to reduce API calls
- **Result caching** for repeated searches
- **Lazy loading** of dropdown content

### Caching Strategy

Consider implementing:
- **Redis caching** for popular search results
- **CDN caching** for static location data
- **Browser caching** for user-specific preferences

## Security Features

- **Row Level Security** enabled on all tables
- **Input validation** and sanitization
- **Rate limiting** on API endpoints (recommended)
- **CORS configuration** for external access

## Monitoring and Maintenance

### Data Quality Checks

Regularly monitor:
- **Duplicate place_ids**
- **Coordinate accuracy**
- **Importance score distribution**
- **Search result relevance**

### Performance Metrics

Track:
- **Search response times**
- **API usage patterns**
- **Database query performance**
- **User satisfaction scores**

## Troubleshooting

### Common Issues

1. **No search results**: Check if the database has data and indexes are created
2. **Slow performance**: Verify database indexes and query optimization
3. **Coordinate errors**: Ensure lat/lon values are valid numbers
4. **Type errors**: Check that all required fields are present

### Debug Mode

Enable debug logging in the API endpoints to troubleshoot issues:

```typescript
console.log('Search query:', query);
console.log('Database result:', data);
```

## Future Enhancements

### Planned Features

- **Fuzzy search** for typos and variations
- **Geographic search** by proximity
- **User preferences** and search history
- **Multi-language support**
- **Advanced filtering** by region, climate, etc.

### Integration Opportunities

- **Weather APIs** for destination planning
- **Currency APIs** for cost estimation
- **Transportation APIs** for route planning
- **Social media APIs** for popularity metrics

## Support

For technical support or feature requests, please refer to the project documentation or create an issue in the repository.

---

**Note**: This system is designed to be scalable and maintainable. Regular updates to the destination database will ensure users have access to the most current and relevant location information.
