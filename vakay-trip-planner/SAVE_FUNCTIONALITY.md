# Itinerary Save Functionality

## Overview
The itinerary save functionality allows users to edit and save changes to their trip itineraries in real-time. This feature includes:

- **Draft State Management**: Changes are stored in a draft state until saved
- **Bulk Editing**: Select multiple days and apply changes to all at once
- **Real-time Validation**: Form validation ensures data integrity
- **Loading States**: Visual feedback during save operations
- **Error Handling**: Comprehensive error handling with user-friendly messages

## How It Works

### 1. Draft State Management
```typescript
const [draftItinerary, setDraftItinerary] = useState<Map<string, ItineraryDay>>(new Map());
```
- Changes are stored in a Map with date strings as keys
- Original data is preserved until save is confirmed
- Users can cancel to revert all changes

### 2. Save Process
```typescript
const handleSave = async () => {
  setIsSaving(true);
  
  // Convert draft to array format
  const itineraryDaysArray = Array.from(draftItinerary.values())
    .filter(day => day && day.date)
    .map(day => ({ ...day, trip_id: trip.id }));

  // Send to server action
  const formData = new FormData();
  formData.append('tripId', trip.id);
  formData.append('itineraryDays', JSON.stringify(itineraryDaysArray));
  
  formAction(formData);
};
```

### 3. Server Action
The `saveItineraryChanges` server action:
- Validates user authentication and permissions
- Parses and validates the itinerary data
- Uses Supabase upsert to save changes
- Handles conflicts with existing data
- Returns success/error messages

### 4. Error Handling
- **Authentication**: Checks if user is logged in
- **Permissions**: Verifies user has access to the trip
- **Data Validation**: Validates itinerary data structure
- **Database Errors**: Handles Supabase operation errors
- **User Feedback**: Shows success/error messages with icons

## Features

### Bulk Editing
- Select multiple days using checkboxes
- Apply location changes to all selected days
- Clear selection with dedicated button

### Individual Day Editing
- Click on a single day to edit its details
- Set primary and transfer locations
- Add notes for each day
- Toggle transfer mode

### Visual Feedback
- Loading spinner during save operations
- Success/error messages with appropriate icons
- Disabled buttons during save
- Color-coded locations with proper text contrast

## Database Schema

The functionality uses the `itinerary_days` table:
```sql
CREATE TABLE itinerary_days (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  trip_id uuid REFERENCES trips(id) ON DELETE CASCADE NOT NULL,
  date date NOT NULL,
  notes text,
  summary text,
  location_1_id bigint REFERENCES locations(id) ON DELETE SET NULL,
  location_2_id bigint REFERENCES locations(id) ON DELETE SET NULL,
  UNIQUE (trip_id, date)
);
```

## Security

- **Row Level Security (RLS)**: Enabled on all tables
- **Authentication**: All operations require valid user session
- **Authorization**: Users can only edit trips they participate in
- **Input Validation**: Zod schemas validate all input data
- **SQL Injection Protection**: Parameterized queries via Supabase

## Performance

- **Optimistic Updates**: UI updates immediately, syncs with server
- **Bulk Operations**: Single database call for multiple day updates
- **Efficient Revalidation**: Only revalidates affected paths
- **Minimal Re-renders**: Uses React state efficiently

## Future Enhancements

1. **Real-time Collaboration**: Multiple users editing simultaneously
2. **Undo/Redo**: History of changes with ability to revert
3. **Auto-save**: Automatic saving of changes
4. **Conflict Resolution**: Handle concurrent edits
5. **Offline Support**: Work offline, sync when online
